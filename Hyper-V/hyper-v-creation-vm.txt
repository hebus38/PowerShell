Cr√©e une VM sur un h√¥te Hyper-V distant

Configure le disque, la m√©moire, le r√©seau

Installe Windows Server via un VHDX de r√©f√©rence

Utilise un fichier Unattend.xml pour automatiser l‚Äôinstallation

Pr√©pare la VM √† devenir contr√¥leur de domaine

üõ†Ô∏è Script PowerShell : Cr√©ation d‚Äôun DC sur Hyper-V distant
powershell
# Param√®tres de base
$VMName        = "DC1"
$VMHost        = "SRVHYPERV"                # Nom de l'h√¥te Hyper-V distant
$VMPath        = "\\$VMHost\D$\VMs\$VMName" # Partage r√©seau vers le dossier VM
$VHDXTemplate  = "\\$VMHost\D$\Reference\WS2022.vhdx" # VHDX de r√©f√©rence
$VHDXPath      = "$VMPath\$VMName.vhdx"
$SwitchName    = "ReskitSwitch"             # Nom du commutateur virtuel
$MemoryStartup = 4GB
$UnattendFile  = "\\$VMHost\D$\Unattend\UnattendDC.xml"

# Copie du VHDX de r√©f√©rence
Copy-Item -Path $VHDXTemplate -Destination $VHDXPath

# Cr√©ation de la VM sur l‚Äôh√¥te distant
Invoke-Command -ComputerName $VMHost -ScriptBlock {
    param($VMName, $VMPath, $VHDXPath, $SwitchName, $MemoryStartup)

    New-VM -Name $VMName -MemoryStartupBytes $MemoryStartup -Generation 2 -Path $VMPath -SwitchName $SwitchName
    Set-VMFirmware -VMName $VMName -EnableSecureBoot Off
    Add-VMHardDiskDrive -VMName $VMName -Path $VHDXPath
} -ArgumentList $VMName, $VMPath, $VHDXPath, $SwitchName, $MemoryStartup

# Injection du fichier Unattend.xml dans le VHDX
Invoke-Command -ComputerName $VMHost -ScriptBlock {
    param($VHDXPath, $UnattendFile)

    # Montage du VHDX
    $disk = Mount-VHD -Path $VHDXPath -Passthru
    $vol = ($disk | Get-Disk | Get-Partition | Get-Volume)[0]
    Copy-Item -Path $UnattendFile -Destination "$($vol.DriveLetter):\Windows\Panther\Unattend.xml"
    Dismount-VHD -Path $VHDXPath
} -ArgumentList $VHDXPath, $UnattendFile

# D√©marrage de la VM
Invoke-Command -ComputerName $VMHost -ScriptBlock {
    param($VMName)
    Start-VM -Name $VMName
} -ArgumentList $VMName

Write-Host "‚úÖ La VM '$VMName' est cr√©√©e et en cours d'installation sur '$VMHost'."

üì¶ Ce dont tu as besoin c√¥t√© h√¥te Hyper-V
Le r√¥le Hyper-V activ√©

Un dossier partag√© (D:\VMs, D:\Reference, D:\Unattend)

Le fichier ISO de Windows Server mont√© dans un VHDX via New-ReferenceVHDX.ps1

Un fichier UnattendDC.xml adapt√© pour installer et promouvoir le serveur en tant que DC

üß† Astuce : contenu minimal du fichier UnattendDC.xml
Tu peux t‚Äôinspirer de celui du d√©p√¥t Reskit, avec :

xml
<ComputerName>DC1</ComputerName>
<FullName>Administrator</FullName>
<OrganizationName>Reskit</OrganizationName>
<DomainName>reskit.local</DomainName>
<Password>Pa$$w0rd</Password>	