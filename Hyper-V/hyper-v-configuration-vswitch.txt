<#


https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/get-started/create-a-virtual-switch-for-hyper-v-virtual-machines?tabs=powershell&pivots=windows
#>


ğŸ§­ Ã‰tape 1 : PrÃ©paration de lâ€™hÃ´te Hyper-V
ğŸ”¹ Objectifs :
VÃ©rifier le support VLAN
CrÃ©er un commutateur virtuel externe
Activer le tagging VLAN pour lâ€™OS hÃ´te
Attribuer une IP Statique de gestion pour le VLAN 10 (MGMT)


ğŸ› ï¸ Commandes PowerShell :
Get-NetAdapterAdvancedProperty -Name "Ethernet" | Where-Object DisplayName -Match "VLAN" | Format-List
New-VMSwitch -Name <...> -NetAdapterName "Ethernet" -AllowManagementOS $true
New-NetIPAddress -InterfaceAlias "vEthernet" -IPAddress 192.168.1.10 -PrefixLength 24

# Identification des VLANs (Seulement si le routage le permet):
Set-VMNetworkAdapterVlan -ManagementOS -Access -VlanId 10

# Suppression de lâ€™IP statique assignÃ©e Ã  lâ€™interface physique:
$if = Get-NetAdapter | Where-Object { $_.Name -eq "Ethernet" }
Remove-NetIPAddress -InterfaceIndex $if.InterfaceIndex -AddressFamily IPv4 -Confirm:$false

ğŸ§­ Ã‰tape 1 bis: CrÃ©ation dâ€™une VM Windows Server avec le role "Routing and Remote Access Service - RRAS":
Voir script   	



ğŸ§­ Ã‰tape 2 : CrÃ©ation des VM segmentÃ©es par rÃ´le
ğŸ”¹ VM Ã  crÃ©er :
Nom	RÃ´le	VLAN	IP prÃ©vue
DC1	ContrÃ´leur de domaine	20	10.10.20.10
DC2	RÃ©plica AD	20	10.10.20.11
FS1	Serveur de fichiers	30	10.10.30.10
APP1	Serveur applicatif/test	40	10.10.40.10

ğŸ› ï¸ Script PowerShell (extrait pour DC1) :
powershell
New-VM -Name "DC1" -MemoryStartupBytes 4GB -Generation 2 -SwitchName "ReskitSwitch" -Path "D:\VMs\DC1"
Set-VMNetworkAdapterVlan -VMName "DC1" -Access -VlanId 20
Add-VMHardDiskDrive -VMName "DC1" -Path "D:\VMs\DC1\DC1.vhdx"
Start-VM -Name "DC1"
â¡ï¸ RÃ©pÃ¨te pour chaque VM avec le VLAN correspondant.

ğŸ§­ Ã‰tape 3 : Configuration rÃ©seau interne
ğŸ”¹ Objectifs :
Assigner IP statiques aux VM

VÃ©rifier la communication intra-VLAN

Promouvoir DC1 en AD/DNS

ğŸ› ï¸ Ã€ faire dans les VM :
Configurer IP fixe dans chaque VM

Ping entre DC1 et DC2

Installer AD DS sur DC1 (Install-WindowsFeature AD-Domain-Services)

Promouvoir DC1 (Install-ADDSForest)

ğŸ§­ Ã‰tape 4 : Routage inter-VLAN (optionnel)
ğŸ”¹ Choix :
VM pfSense (ISO) avec plusieurs interfaces VLAN

VM Windows Server avec rÃ´le RRAS

ğŸ› ï¸ pfSense :
CrÃ©er une VM avec 3 ou 4 cartes rÃ©seau

Assigner chaque carte Ã  un VLAN

Activer le routage et le NAT

ğŸ› ï¸ RRAS :
powershell
Install-WindowsFeature RemoteAccess -IncludeManagementTools
Install-WindowsFeature Routing
â¡ï¸ Configure les interfaces et les routes manuellement ou via netsh.

ğŸ§­ Ã‰tape 5 : AccÃ¨s Internet pour les VM
Le VLAN 10 (gestion) a dÃ©jÃ  accÃ¨s via ta box

Les autres VLANs passent par pfSense/RRAS

Tu peux crÃ©er une rÃ¨gle NAT ou une passerelle vers 192.168.1.1

ğŸ§  Tu veux aller plus loinâ€¯?
Ajouter DHCP par VLAN (via pfSense ou DC1)

IntÃ©grer WSUS, MDT, ou un serveur de sauvegarde

Simuler des attaques ou tests de sÃ©curitÃ© (lab Red/Blue Team)

Je peux te gÃ©nÃ©rer un script complet de crÃ©ation des VM avec VLANs, ou tâ€™aider Ã  installer pfSense Ã©tape par Ã©tape. Tu prÃ©fÃ¨res quâ€™on commence par le script VM ou le routeur virtuelâ€¯?